<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Bazos Listings Map</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>User Management</h1>
            <div class="header-actions">
                <div class="page-actions">
                    <button class="btn btn-primary" id="add-user-btn">+ Add User</button>
                </div>
                <div class="user-info" id="nav-container"></div>
            </div>
        </header>

        <div id="message-container"></div>

        <div class="card users-table">
            <div class="table-header">
                <h2>All Users</h2>
            </div>
            <div id="users-content">
                <div class="loading-text">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="close" id="close-add-user">&times;</button>
            </div>
            <div class="modal-body">
                <div class="error-message" id="modal-error" style="display: none;"></div>

                <form id="addUserForm">
                    <div class="form-group">
                        <label for="newEmail">Email Address *</label>
                        <input type="email" id="newEmail" name="email" required
                               placeholder="user@example.com">
                    </div>

                    <div class="form-group">
                        <label for="newPassword">Password *</label>
                        <input type="password" id="newPassword" name="password" required
                               placeholder="Enter password">
                    </div>

                    <div class="form-group">
                        <label for="newName">Full Name *</label>
                        <input type="text" id="newName" name="name" required
                               placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="newRole">Role *</label>
                        <select id="newRole" name="role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-add-user">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/common.js"></script>
    <script>
        let users = [];
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth({ requireAdmin: true });
            if (!user) return;

            currentUserId = user.id;
            await loadUsers();

            document.getElementById('add-user-btn').addEventListener('click', openAddUserModal);
            document.getElementById('close-add-user').addEventListener('click', closeAddUserModal);
            document.getElementById('cancel-add-user').addEventListener('click', closeAddUserModal);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);

            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('addUserModal')) {
                    closeAddUserModal();
                }
            });
        });

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', { credentials: 'include' });
                if (response.ok) {
                    users = await response.json();
                    renderUsers();
                } else {
                    document.getElementById('users-content').innerHTML =
                        '<div class="loading-text">Error loading users</div>';
                }
            } catch (error) {
                document.getElementById('users-content').innerHTML =
                    '<div class="loading-text">Error loading users</div>';
            }
        }

        function renderUsers() {
            const content = document.getElementById('users-content');

            if (users.length === 0) {
                content.innerHTML = '<div class="loading-text">No users found</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${escapeHtml(user.name)}</td>
                                <td>${escapeHtml(user.email)}</td>
                                <td><span class="role-badge role-${escapeHtml(user.role)}">${escapeHtml(user.role)}</span></td>
                                <td><span class="status-${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" data-delete-user="${user.id}"
                                            ${user.id === currentUserId ? 'disabled' : ''}>
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = tableHTML;

            // Attach delete handlers via event delegation
            content.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-delete-user]');
                if (btn && !btn.disabled) {
                    deleteUser(parseInt(btn.dataset.deleteUser));
                }
            });
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            document.getElementById('addUserForm').reset();
            document.getElementById('modal-error').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        async function handleAddUser(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const userData = {
                email: formData.get('email'),
                password: formData.get('password'),
                name: formData.get('name'),
                role: formData.get('role')
            };

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    closeAddUserModal();
                    showMessage('User created successfully', 'success');
                    await loadUsers();
                } else {
                    document.getElementById('modal-error').textContent = data.error || 'Failed to create user';
                    document.getElementById('modal-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('modal-error').textContent = 'Network error. Please try again.';
                document.getElementById('modal-error').style.display = 'block';
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showMessage('User deleted successfully', 'success');
                    await loadUsers();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
